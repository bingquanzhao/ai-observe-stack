{{/*
Grafana Provisioning ConfigMaps
*/}}
{{- if .Values.grafana.enabled }}
---
# Datasources ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oos.grafana.fullname" . }}-datasources
  labels:
    {{- include "oos.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
    grafana_datasource: "1"
data:
  datasources.yaml: |
    # Grafana Datasource Provisioning
    # Auto-provision Doris as MySQL-compatible datasource
    apiVersion: 1

    datasources:
      # Apache Doris - MySQL Protocol
      - name: Doris
        type: mysql
        uid: doris
        url: {{ include "oos.doris.mysqlEndpoint" . }}
        user: {{ include "oos.doris.user" . }}
        database: {{ include "oos.doris.database" . }}
        isDefault: true
        jsonData:
          maxOpenConns: 10
          maxIdleConns: 10
          connMaxLifetime: 14400
          tlsSkipVerify: true
        secureJsonData:
          password: "{{ include "oos.doris.password" . }}"
        editable: true

---
# Dashboard Providers ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oos.grafana.fullname" . }}-dashboard-providers
  labels:
    {{- include "oos.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
data:
  dashboards.yaml: |
    # Grafana Dashboard Provisioning
    apiVersion: 1

    providers:
      - name: 'Open Observability Stack Dashboards'
        orgId: 1
        folder: 'Open Observability Stack'
        folderUid: oos-observability
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/oos
{{- end }}
